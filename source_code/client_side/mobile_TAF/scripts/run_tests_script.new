#!/bin/sh

#Run as root.

# Script review
################################################################################
echo "
....................Build and install test system script........................
"

################################################################################

# Section 1: Set up
################################################################################

## Define directories
echo '# Section 1: Set up'

## read config file test_system.config(run script as './install_test_system.new test_system.config')
. $1

svn_up_dir="/Volumes/DATA/testing"
# build_sh_script_dir="$svn_up_dir/current/Sources/ProjectName"
autotests_dir="$svn_up_dir/solution/MobileTAF"
autotests_logs_dir="$autotests_dir/logs"
ant_dir="$autotests_dir/lib/ant"
report_dir="$autotests_dir/build/junitreport"

## Define e-mail list
if [ "$testing_mode" == "work" ]
then
   address_list="Viktar_Karanevich@epam.com"
else 
   address_list="Viktar_Karanevich@epam.com"
fi

## testing mode
testing_mode=$testing_mode

## Define default user
user="root"

## Define script steps statuses:
pass="[PASS]"
fail="[FAIL]"
step_1="1) Network services check: "

## Define sources and test revisions

## Print directory variables
echo "svn_up_dir          =  $svn_up_dir"
echo "autotests_dir       =  $autotests_dir"
echo "ant_dir             =  $ant_dir"
echo "report_dir          =  $report_dir"
echo "address_list        =  $address_list for mode: $testing_mode"

## Define start time
start_time=`date '+DATE-%m-%d-%y-TIME-%H-%M-%S'`
current_time=`date '+%Y-%m-%d'`
search_logs_pattern="*$current_time*"

## Create empty logs file
cd $autotests_logs_dir
## recode into function
# logs:
svn_up_log=$autotests_logs_dir/svn_up_$start_time.log
build_script_log=$autotests_logs_dir/build_script_$start_time.log
short_report_file=$autotests_logs_dir/report_$start_time.txt
report_log=$autotests_logs_dir/report_$start_time.log
# creating empty log files
touch $svn_up_log $build_script_log $short_report_file $report_log

## Section result:
step_1="$step_1 $pass"
################################################################################

# Section 2: Run autotests
################################################################################
echo '# Section 2: Run autotests'

export ANT_HOME=$ant_dir
cd $autotests_dir
sh $ant_dir/bin/ant test

RETVAL=$?
if [ $RETVAL -eq 0 ] 
then
   step_2="$step_2 $pass"
else
   step_2="$step_2 $fail"
fi

###############################################################################

# Section 3: Send results on e-mail
###############################################################################
echo '# Section 3: Send results on e-mail'

cd $report_dir
ls -al
report_file=`ls -al | grep *TEST* | awk '{print $9;}'`
echo "report_file: $report_file"
sed -n '1,2p' $report_file > $short_report_file
sed -n '/Testcase/,$p' $report_file >> report_tmp.txt
## editing report

perl -e 'undef $/; $in = <STDIN>; print "$1\n" while ($in =~ m/(.*?\n^\s+(?s:.*?)^\s*$)/mg); print "\n";' < report_tmp.txt > fail.txt
perl -e 'undef $/; $in = <STDIN>; print "$1\tPASS\n" while ($in =~ m/(^Testcase.*$)(?!\n\s+)/mg); print "\n";' < report_tmp.txt > pass.txt
echo ' \n' && echo '   FAIL tests:' >> $short_report_file && cat fail.txt >> $short_report_file && echo '   PASS tests:' >> $short_report_file && cat pass.txt >> $short_report_file
echo "Additional info:" >> $short_report_file

echo " $step_1" >> $short_report_file
echo "     " >> $short_report_file
echo "----------------------------------------------------------------------------" >> $short_report_file
echo "For detailed information, please see logs using file url: $autotests_logs_dir" >> $short_report_file

mail -s "[PROJECT AUTOTEST] build revision 1" $address_list < $short_report_file
#cat report.txt | mail -s "[PROJECT AUTOTEST] build revision 1" $address_list 
# < $report_file && $build_sh_script_dir/build_script_log.txt

# copy autotests full report into main logs directory
cp $report_file $report_log

echo 'end e-mail section'
###############################################################################

## extra e-mail for test supporter with script and config files
#mutt -s "[AUTOTEST] build $revision" -a /Volumes/Data/archive/scripts/run_tests_script.new -a /Volumes/Data/archive/scripts/test_system.config "Viktar_Karanevich@epam.com" < $report_file

echo "All logs could be found here: $autotests_logs_dir"
# find $manager_logs_dir/$search_logs_pattern -type f | xargs tar rvf $manager_logs_tar
# echo "find $broker_logs_dir/$search_logs_pattern -type f | xargs tar rvf $broker_logs_tar" | ssh $broker_1 
# scp $user@$broker_1:/$broker_logs_tar $autotests_logs_dir

ls -al $autotests_logs_dir

echo "....................script end........................"
